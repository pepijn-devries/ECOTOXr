<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Sanitising ECOTOX • ECOTOXr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Sanitising ECOTOX">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ECOTOXr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.2.0002</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/ecotox-schema.html">ECOTOX database schema</a></li>
    <li><a class="dropdown-item" href="../articles/reproducibility.html">Reproducibility</a></li>
    <li><a class="dropdown-item" href="../articles/sanitising-ecotox.html">Sanitising ECOTOX</a></li>
    <li><a class="dropdown-item" href="../articles/searching-ecotox.html">Searching ECOTOX</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/pepijn-devries/ECOTOXr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Sanitising ECOTOX</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/pepijn-devries/ECOTOXr/blob/main/vignettes/sanitising-ecotox.Rmd" class="external-link"><code>vignettes/sanitising-ecotox.Rmd</code></a></small>
      <div class="d-none name"><code>sanitising-ecotox.Rmd</code></div>
    </div>

    
    
<p>The ASCII files provided by the EPA contain all data required for
building the local database (<code><a href="../reference/download_ecotox_data.html">download_ecotox_data()</a></code>). As
documented by the EPA most table fields are stored as text (with a few
exceptions). During the build process, all fields are kept as is,
without any cleanup or standardisation. This is done to avoid any data
loss or corruption and keep it as close to the source as possible.
Therefore, it is likely that you need to post-process data after
querying the locally built database.</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?><!-- Generated by graphviz version 2.40.1 (20161225.0304)
 --><!-- Title: ProTracker modules Pages: 1 --><svg width="636pt" height="44pt" viewbox="0.00 0.00 636.00 26.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale (0.6 0.6) rotate(0) translate(4 40)"><title>ProTracker modules</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-40 632,-40 632,4 -4,4"></polygon><!-- build --><g id="node1" class="node"><title>build</title>
<path fill="#ffffff" stroke="#000000" d="M118,-36C118,-36 12,-36 12,-36 6,-36 0,-30 0,-24 0,-24 0,-12 0,-12 0,-6 6,0 12,0 12,0 118,0 118,0 124,0 130,-6 130,-12 130,-12 130,-24 130,-24 130,-30 124,-36 118,-36"></path><text text-anchor="middle" x="65" y="-22.2" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">build database</text><text text-anchor="middle" x="65" y="-5.4" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">from EPA files</text></g><!-- query --><g id="node2" class="node"><title>query</title>
<path fill="#ffffff" stroke="#000000" d="M284,-36C284,-36 178,-36 178,-36 172,-36 166,-30 166,-24 166,-24 166,-12 166,-12 166,-6 172,0 178,0 178,0 284,0 284,0 290,0 296,-6 296,-12 296,-12 296,-24 296,-24 296,-30 290,-36 284,-36"></path><text text-anchor="middle" x="231" y="-13.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">query database</text></g><!-- build&#45;&gt;query --><g id="edge1" class="edge"><title>build-&gt;query</title>
<path fill="none" stroke="#000000" d="M130.1312,-18C130.1312,-18 155.7842,-18 155.7842,-18"></path><polygon fill="#000000" stroke="#000000" points="155.7842,-21.5001 165.7842,-18 155.7842,-14.5001 155.7842,-21.5001"></polygon></g><!-- post --><g id="node3" class="node"><title>post</title>
<path fill="#ffffff" stroke="#000000" d="M450,-36C450,-36 344,-36 344,-36 338,-36 332,-30 332,-24 332,-24 332,-12 332,-12 332,-6 338,0 344,0 344,0 450,0 450,0 456,0 462,-6 462,-12 462,-12 462,-24 462,-24 462,-30 456,-36 450,-36"></path><text text-anchor="middle" x="397" y="-22.2" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">post process/</text><text text-anchor="middle" x="397" y="-5.4" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">cleanup</text></g><!-- query&#45;&gt;post --><g id="edge2" class="edge"><title>query-&gt;post</title>
<path fill="none" stroke="#000000" d="M296.1312,-18C296.1312,-18 321.7842,-18 321.7842,-18"></path><polygon fill="#000000" stroke="#000000" points="321.7842,-21.5001 331.7842,-18 321.7842,-14.5001 321.7842,-21.5001"></polygon></g><!-- ana --><g id="node4" class="node"><title>ana</title>
<path fill="#ffffff" stroke="#000000" d="M616,-36C616,-36 510,-36 510,-36 504,-36 498,-30 498,-24 498,-24 498,-12 498,-12 498,-6 504,0 510,0 510,0 616,0 616,0 622,0 628,-6 628,-12 628,-12 628,-24 628,-24 628,-30 622,-36 616,-36"></path><text text-anchor="middle" x="563" y="-13.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">further analyses</text></g><!-- post&#45;&gt;ana --><g id="edge3" class="edge"><title>post-&gt;ana</title>
<path fill="none" stroke="#000000" d="M462.1312,-18C462.1312,-18 487.7842,-18 487.7842,-18"></path><polygon fill="#000000" stroke="#000000" points="487.7842,-21.5001 497.7842,-18 487.7842,-14.5001 487.7842,-21.5001"></polygon></g></g></svg><p>Although it is the user’s responsibility to evaluate the correctness
and validity of the data, the <code>ECOTOXr</code> package provides some
tools to make the cleanup process easier. This vignette presents
important aspects for cleaning:</p>
<ul>
<li><a href="#sanitising-units">units</a></li>
<li><a href="#sanitising-numerics">numeric data</a></li>
<li><a href="#sanitising-dates">dates</a></li>
</ul>
<p>In general there are two types of sanitising functions; those named
<code>as_..._ecotox()</code> and those starting with
<code>process_ecotox_...s()</code>. Where ‘<code>...</code>’ is the data
type being sanitised (e.g. <code>unit</code>, <code>numeric</code>, or
<code>date</code>). The first function type (‘as’) handles vectors of
<code>character</code>s. The second function type (‘process’), handles
<code>data.frame</code>s, where relevant columns are automatically
detected and processed with the ‘as’ type functions.</p>
<p>Note that the sanitation routines are subject to development, so they
may change. For reproducible results you should therefore always report
the version of <code>ECOTOXr</code> you are using
(<code><a href="../reference/cite_ecotox.html">cite_ecotox()</a></code>).</p>
<div class="section level2">
<h2 id="sanitising-units">Sanitising units<a class="anchor" aria-label="anchor" href="#sanitising-units"></a>
</h2>
<p>Quantity units are vital for the interpretation of measurements. The
ECOTOX database contains units as reported by its source publication. As
a result, the units are often not stored consistently and are not
standardised. The <code>ECOTOXr</code> package implements a function
that sanitises the unit text fields and then parses them with the <a href="https://r-quantities.github.io/units/" class="external-link">units package</a>. This
package provides instruments to convert units using the <a href="https://www.unidata.ucar.edu/software/udunits/" class="external-link">UNIDATA udunits
library</a>.</p>
<p>The advantage of using the <code>units</code> package is that it
provides a mechanism to apply arithmetic manipulations of data and
conversion between compatible units. Or as the documentation of the
package puts it: “<em>When used in expression, it automatically converts
units, and simplifies units of results when possible; in case of
incompatible units, errors are raised</em>”</p>
<p>So the goal of the sanitation steps here is to create a format that
can be parsed by the <code>units</code> package. In order to achieve
this the following steps are performed:</p>
<ul>
<li>Annotations are stripped (i.e., prefixes and suffixes to units,
indicating for instance ‘active ingredient’, the medium it refers to
(e.g. soil), etc.)</li>
<li>Ambiguous units like percentages and ‘parts per …’ are converted to
more explicit units where possible. This is only possible when it is
recorded if the units indicate if they are w/w, w/v, v/v or v/w. If this
annotation is missing from ‘parts per …’ units, it is assumed to be
weight over volume. The same is true for percentages, but only if the
unit type is <code>concentration</code>.</li>
<li>Units that are not known or interpreted incorrectly by the
<code>units</code> package are converted such that they are handled
correctly. For instance ‘C’ in the ECOTOX database frequently stands for
‘degrees Celsius’ (although it is also used to indicate Carbon). So if
it’s not an annotation, ‘C’ is replaced with ‘Celsius’. Another example
is ‘sqft’ (square feet) which can not be interpreted by the units
package is replaced with ‘ft2’.</li>
<li>Units that are not reported or interpretable are set as generic
‘unit’ (<code>units::mixed_units(1, "unit")</code>).</li>
</ul>
<p>The documentation of the <code><a href="../reference/as_unit_ecotox.html">as_unit_ecotox()</a></code> function has a
more detailed description of the cleanup procedure. If you need even
more details you can check the <a href="https://github.com/pepijn-devries/ECOTOXr/blob/main/R/process_unit.r" class="external-link">source
code</a>.</p>
<p>In order to demonstrate how unit sanitation works in this packages,
let’s first initialise a vector of mishmash units. These are actually a
random sample from the ECOTOX database, not necessarily the most common
ones:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/pepijn-devries/ECOTOXr" class="external-link">ECOTOXr</a></span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>   <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mishmash</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ppm-d"</span>, <span class="st">"ml/2.5 cm eu"</span>, <span class="st">"fl oz/10 gal/1k sqft"</span>, <span class="st">"kg/100 L"</span>,</span>
<span>    <span class="st">"mopm"</span>, <span class="st">"ng/kg"</span>, <span class="st">"ug"</span>, <span class="st">"AI ng/g"</span>, <span class="st">"PH"</span>, <span class="st">"pm"</span>, <span class="st">"uM/cm3"</span>, <span class="st">"1e-4 mM"</span>,</span>
<span>    <span class="st">"degree"</span>, <span class="st">"fs"</span>, <span class="st">"mg/TI"</span>, <span class="st">"RR"</span>, <span class="st">"ug/g org/d"</span>, <span class="st">"1e+4 IU/TI"</span>, <span class="st">"pg/mg TE"</span>,</span>
<span>    <span class="st">"pmol/mg"</span>, <span class="st">"1e-9/l"</span>, <span class="st">"no &gt;15 cm"</span>, <span class="st">"umol/mg pro"</span>, <span class="st">"cc/org/wk"</span>, <span class="st">"PIg/L"</span>,</span>
<span>    <span class="st">"ug/100 ul/org"</span>, <span class="st">"ae mg/kg diet/d"</span>, <span class="st">"umol/mg/h"</span>, <span class="st">"cmol/kg d soil"</span>,</span>
<span>    <span class="st">"ug/L diet"</span>, <span class="st">"kg/100 kg sd"</span>, <span class="st">"1e+6 cells"</span>, <span class="st">"ul diet"</span>, <span class="st">"S"</span>, <span class="st">"mmol/h/g TI"</span>,</span>
<span>    <span class="st">"g/70 d"</span>, <span class="st">"vg"</span>, <span class="st">"ng/200 mg diet"</span>, <span class="st">"uS/cm2"</span>, <span class="st">"AI ml/ha"</span>, <span class="st">"AI pt/acre"</span>,</span>
<span>    <span class="st">"mg P/h/g TI"</span>, <span class="st">"no/m"</span>, <span class="st">"kg/ton sd"</span>, <span class="st">"ug/g wet wt"</span>, <span class="st">"AI mg/2 L diet"</span>,</span>
<span>    <span class="st">"nmol/TI"</span>, <span class="st">"umol/g wet wt"</span>, <span class="st">"PSU"</span>, <span class="st">"Wijs number"</span><span class="op">)</span></span></code></pre></div>
<p>With <code><a href="../reference/as_unit_ecotox.html">as_unit_ecotox()</a></code>, the mishmash of units,
represented by <code>character</code> strings are cleaned and coerced to
<code><a href="https://r-quantities.github.io/units/reference/mixed_units.html" class="external-link">units::mixed_units()</a></code>. As <code>units</code> objects have a
numeric component, but the <code>character</code> strings from the
database do not, each unit is given a value of <code>1</code>. As you
can see not all units in the <code>mishmash</code> vector can be
interpreted and are just returned as arbitrary <code>1 unit</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/as_unit_ecotox.html">as_unit_ecotox</a></span><span class="op">(</span><span class="va">mishmash</span>, warn <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Mixed units: d*ppm (1), ml/2.5cm (1), oz/1000ft2/10gal (1), kg/100L (1), month (1), ng/kg (1), ug (1), ng/g (1), unit (13), umol/cm3/L (1), 0.0001mmol/L (1), ° (1), ug/d/g (1), pg/mg (1), pmol/mg (1), umol/mg (1), counts/counts/week (1), ug/100ul/counts (1), mg/d/kg (1), umol/h/mg (1), cmol/kg (1), ug/L (1), kg/100kg (1), 1000000counts (1), ul (1), S (1), mmol/g/h (1), g/70d (1), ng/200mg (1), uS/cm2 (1), ml/ha (1), pt/acre (1), mg/g/h (1), counts/m (1), kg/ton (1), ug/g (1), mg/2L (1), umol/g (1) </span></span>
<span><span class="co">#&gt; 1 [d*ppm], 1 [ml/2.5cm], 1 [oz/1000ft2/10gal], 1 [kg/100L], 1 [month], 1 [ng/kg], 1 [ug], 1 [ng/g], 1 [unit], 1 [unit], 1 [umol/cm3/L], 1 [0.0001mmol/L], 1 [°], 1 [unit], 1 [unit], 1 [unit], 1 [ug/d/g], 1 [unit], 1 [pg/mg], 1 [pmol/mg], 1 [unit], 1 [unit], 1 [umol/mg], 1 [counts/counts/week], 1 [unit], 1 [ug/100ul/counts], 1 [mg/d/kg], 1 [umol/h/mg], 1 [cmol/kg], 1 [ug/L], 1 [kg/100kg], 1 [1000000counts], 1 [ul], 1 [S], 1 [mmol/g/h], 1 [g/70d], 1 [unit], 1 [ng/200mg], 1 [uS/cm2], 1 [ml/ha], 1 [pt/acre], 1 [mg/g/h], 1 [counts/m], 1 [kg/ton], 1 [ug/g], 1 [mg/2L], 1 [unit], 1 [umol/g], 1 [unit], 1 [unit]</span></span></code></pre></div>
<p>With <code><a href="../reference/process_ecotox_units.html">process_ecotox_units()</a></code> you can process an entire
<code>data.frame</code>/<code>tibble</code>, where each column ending
with <code>_unit</code> is processed (i.e. <code><a href="../reference/as_unit_ecotox.html">as_unit_ecotox()</a></code>
is called on them). By setting the <code>.names</code> argument, you can
preserve the original unit column:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>mishmash_unit <span class="op">=</span> <span class="va">mishmash</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/process_ecotox_units.html">process_ecotox_units</a></span><span class="op">(</span>.names <span class="op">=</span> <span class="st">"{.col}_parsed"</span>, warn <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 50 × 2</span></span></span>
<span><span class="co">#&gt;    mishmash_unit        mishmash_unit_parsed</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                       <span style="color: #949494; font-style: italic;">&lt;mixed_units&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> ppm-d                           1<span style="color: #949494;"> [d*ppm]</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> ml/2.5 cm eu                 1<span style="color: #949494;"> [ml/2.5cm]</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> fl oz/10 gal/1k sqft 1<span style="color: #949494;"> [oz/1000ft2/10gal]</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> kg/100 L                      1<span style="color: #949494;"> [kg/100L]</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> mopm                            1<span style="color: #949494;"> [month]</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> ng/kg                           1<span style="color: #949494;"> [ng/kg]</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> ug                                 1<span style="color: #949494;"> [ug]</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> AI ng/g                          1<span style="color: #949494;"> [ng/g]</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> PH                               1<span style="color: #949494;"> [unit]</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> pm                               1<span style="color: #949494;"> [unit]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 40 more rows</span></span></span></code></pre></div>
<div class="section level3">
<h3 id="consequences-of-unit-sanitation">Consequences of unit sanitation<a class="anchor" aria-label="anchor" href="#consequences-of-unit-sanitation"></a>
</h3>
<p>As the database contains over 6,000 unique unit codes, it is likely
that not all units are processable. Also, because the codes are not
always consistent, some of them may not be interpreted correctly. Most
frequently occurring units should parse correctly. If you think a
specific code is not parsed correctly, and it is not highly outlandish,
you could <a href="https://github.com/pepijn-devries/ECOTOXr/issues" class="external-link">file an issue
report</a>. Furthermore, you should always inspect automatically parsed
units for correctness.</p>
<p>Another point of attention is the removal of annotations from the
unit. Consider the concentration unit with the following
annotations:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/as_unit_ecotox.html">as_unit_ecotox</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mg/L CO3"</span>, <span class="st">"mg/L CaCO3"</span>, <span class="st">"mg/L HCO3"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Mixed units: mg/L (3) </span></span>
<span><span class="co">#&gt; 1 [mg/L], 1 [mg/L], 1 [mg/L]</span></span></code></pre></div>
<p>Note that they are all interpreted as <code>[mg/L]</code>. Although
technically the same unit, they are definitely not directly compatible.
The <code>units</code> package does not support annotations, so you need
to keep track of them yourself.</p>
</div>
</div>
<div class="section level2">
<h2 id="sanitising-numerics">Sanitising numerics<a class="anchor" aria-label="anchor" href="#sanitising-numerics"></a>
</h2>
<p>First let me explain what is meant by ‘numerics’ in the ECOTOX
database. These are all records that have a accompanying measurement
unit in the database. This includes, concentrations, durations and many
others. These records are stored as text fields in the database. So in
order to interpret them as actual numerics in R, they need to be coerced
to numerics. You could use a simple call to <code><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric()</a></code> to
do this, but that will not always work.</p>
<p>The text fields may contain operators such as ‘&lt;’, ‘&gt;’, ‘~’,
etc. I think this is a mistake and not by design, because many of the
numeric fields have a corresponding operator field where this operator
could be stored. Text fields can also contain labelling text (such as
asterisk symbol) or inconsistent decimal or thousand separators.</p>
<p>This is why there is <code><a href="../reference/as_numeric_ecotox.html">as_numeric_ecotox()</a></code> which first
cleans the text records before coercing them to numerics:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Text fields as possibly encountered in the database</span></span>
<span><span class="va">text_records</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"10"</span>, <span class="st">" 2"</span>, <span class="st">"3 "</span>, <span class="st">"~5"</span>, <span class="st">"9.2*"</span>, <span class="st">"2,33"</span>,</span>
<span>    <span class="st">"2,333"</span>, <span class="st">"2.1(1.0 - 3.2)"</span>, <span class="st">"1-5"</span>, <span class="st">"1e-3"</span><span class="op">)</span></span>
<span>  </span>
<span><span class="fu"><a href="../reference/as_numeric_ecotox.html">as_numeric_ecotox</a></span><span class="op">(</span><span class="va">text_records</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in as_numeric_ecotox(text_records): NAs introduced by coercion</span></span>
<span><span class="co">#&gt;  [1]   10.000    2.000    3.000    5.000    9.200    2.330 2333.000    2.100</span></span>
<span><span class="co">#&gt;  [9]       NA    0.001</span></span>
<span><span class="co">#&gt; attr(,"has_notation")</span></span>
<span><span class="co">#&gt;  [1] FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE</span></span>
<span><span class="co">#&gt; attr(,"has_brackets")</span></span>
<span><span class="co">#&gt;  [1] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE</span></span></code></pre></div>
<p>You can use <code><a href="../reference/process_ecotox_numerics.html">process_ecotox_numerics()</a></code> to process a
<code>data.frame</code>/<code>tibble</code> resulting from a search
query. It automatically applies <code><a href="../reference/as_numeric_ecotox.html">as_numeric_ecotox()</a></code> to
columns containing numeric information:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">text_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>conc1_mean <span class="op">=</span> <span class="va">text_records</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/process_ecotox_numerics.html">process_ecotox_numerics</a></span><span class="op">(</span><span class="va">text_tbl</span>, warn <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 1</span></span></span>
<span><span class="co">#&gt;    conc1_mean</span></span>
<span><span class="co">#&gt;         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     10    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>      2    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>      3    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>      5    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>      9.2  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>      2.33 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>   <span style="text-decoration: underline;">2</span>333    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>      2.1  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     <span style="color: #BB0000;">NA</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>      0.001</span></span></code></pre></div>
<div class="section level3">
<h3 id="consequences-of-numeric-sanitation">Consequences of numeric sanitation<a class="anchor" aria-label="anchor" href="#consequences-of-numeric-sanitation"></a>
</h3>
<p>As indicated above all notations and operators included with numerics
are stripped in the cleaning process. These notations and operators are
potentially important for the interpretation of the values. It may be
wise to keep track of them. One way to do this is by first trying to
coerce texts to numerics with <code><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric()</a></code> and then with
<code><a href="../reference/as_numeric_ecotox.html">as_numeric_ecotox()</a></code>. The cases where the first returns
<code>NA</code> but the latter returns a value, is likely to contain
notations or operators (or is just inconsistently formatted). You could
also use the <code>.names</code> argument in
<code><a href="../reference/process_ecotox_numerics.html">process_ecotox_numerics()</a></code> to rename the numeric columns and
keep the original text fields.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/process_ecotox_numerics.html">process_ecotox_numerics</a></span><span class="op">(</span><span class="va">text_tbl</span>, warn <span class="op">=</span> <span class="cn">FALSE</span>, .names <span class="op">=</span> <span class="st">"{.col}_num"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    test <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">conc1_mean</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>      <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu"><a href="../reference/as_numeric_ecotox.html">as_numeric_ecotox</a></span><span class="op">(</span><span class="va">conc1_mean</span>, warn <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="co">#&gt; Warning: There was 1 warning in `mutate()`.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> In argument: `test = &amp;...`.</span></span>
<span><span class="co">#&gt; Caused by warning:</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> NAs introduced by coercion</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 3</span></span></span>
<span><span class="co">#&gt;    conc1_mean       conc1_mean_num test </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> <span style="color: #949494;">"</span>10<span style="color: #949494;">"</span>                     10     FALSE</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> <span style="color: #949494;">"</span> 2<span style="color: #949494;">"</span>                      2     FALSE</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> <span style="color: #949494;">"</span>3 <span style="color: #949494;">"</span>                      3     FALSE</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> <span style="color: #949494;">"</span>~5<span style="color: #949494;">"</span>                      5     TRUE </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> <span style="color: #949494;">"</span>9.2*<span style="color: #949494;">"</span>                    9.2   TRUE </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> <span style="color: #949494;">"</span>2,33<span style="color: #949494;">"</span>                    2.33  TRUE </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> <span style="color: #949494;">"</span>2,333<span style="color: #949494;">"</span>                <span style="text-decoration: underline;">2</span>333     TRUE </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> <span style="color: #949494;">"</span>2.1(1.0 - 3.2)<span style="color: #949494;">"</span>          2.1   TRUE </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> <span style="color: #949494;">"</span>1-5<span style="color: #949494;">"</span>                    <span style="color: #BB0000;">NA</span>     FALSE</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> <span style="color: #949494;">"</span>1e-3<span style="color: #949494;">"</span>                    0.001 FALSE</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="combining-numerics-with-units">Combining numerics with units<a class="anchor" aria-label="anchor" href="#combining-numerics-with-units"></a>
</h2>
<p>The steps above show how to sanitise numerics and units separately.
In order to standardise numeric values to a specific unit, these steps
need to be combined. This can be achieved by calling
<code><a href="../reference/process_ecotox_numerics.html">process_ecotox_numerics()</a></code> with <code>add_units</code> set
to <code>TRUE</code>. This will add the corresponding units to the
numeric value. But they are still mixed units. By calling
<code><a href="../reference/mixed_to_single_unit.html">mixed_to_single_unit()</a></code> you can convert the values to a
specific unit.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  conc1_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1"</span>, <span class="st">"2"</span>, <span class="st">"5e-4"</span>, <span class="st">"0.2"</span><span class="op">)</span>,</span>
<span>  conc1_unit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mg/L"</span>, <span class="st">"M"</span>, <span class="st">"% w/v"</span>, <span class="st">"ppt w/v"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/process_ecotox_numerics.html">process_ecotox_numerics</a></span><span class="op">(</span>add_units <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    conc1_mean_standard <span class="op">=</span> <span class="fu"><a href="../reference/mixed_to_single_unit.html">mixed_to_single_unit</a></span><span class="op">(</span><span class="va">conc1_mean</span>, <span class="st">"ug/L"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 3</span></span></span>
<span><span class="co">#&gt;      conc1_mean conc1_unit conc1_mean_standard</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;mixed_units&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                   <span style="color: #949494;">[ug/L]</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>      1<span style="color: #949494;"> [mg/L]</span> mg/L                      <span style="text-decoration: underline;">1</span>000</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     2<span style="color: #949494;"> [mol/L]</span> M                           <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>  5e-04<span style="color: #949494;"> [g/dL]</span> % w/v                     <span style="text-decoration: underline;">5</span>000</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>     0.2<span style="color: #949494;"> [g/L]</span> ppt w/v                 <span style="text-decoration: underline;">200</span>000</span></span></code></pre></div>
<p>Note that in the example above not all units can be converted to the
target unit <code>"ug/L"</code>. This is because concentrations in
‘mol/L’ requires the molar mass of the solute in order to convert. It is
returned as <code>NA</code>.</p>
</div>
<div class="section level2">
<h2 id="sanitising-dates">Sanitising dates<a class="anchor" aria-label="anchor" href="#sanitising-dates"></a>
</h2>
<p>The ECOTOX contains several date fields. They can represent
meta-information about the record (date created and modified),
administrative information (publication date), or experimental
information (application date). These dates are stored as text in the
database. As not all records are consistent or complete, some cleaning
is required before coercing the text to a Date object
(<code><a href="https://rdrr.io/r/base/Dates.html" class="external-link">?Date</a></code>).</p>
<p>The example below shows some typical date formats as encountered in
the database and how to coerce them to <code>Date</code> objects using
<code><a href="../reference/as_date_ecotox.html">as_date_ecotox()</a></code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">char_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"5-19-1987   "</span>, <span class="st">"5/dd/2021"</span>, <span class="st">"3/19/yyyy"</span>, <span class="st">"1985"</span>, <span class="st">"mm/19/1999"</span>,</span>
<span>               <span class="st">"October 2004"</span>, <span class="st">"nr/nr/2015"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/as_date_ecotox.html">as_date_ecotox</a></span><span class="op">(</span><span class="va">char_date</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "1987-05-19" "2021-05-01" NA           "1985-01-01" "1999-01-19"</span></span>
<span><span class="co">#&gt; [6] "2004-10-01" "2015-01-01"</span></span></code></pre></div>
<p>The only date that cannot be coerced is the one with an unspecified
year. It is returned as <code>NA</code>.</p>
<p>You can use <code><a href="../reference/process_ecotox_dates.html">process_ecotox_dates()</a></code> to process a
<code>data.frame</code>/<code>tibble</code> as returned by a search
query. Date columns are automatically coerced with
<code><a href="../reference/as_date_ecotox.html">as_date_ecotox()</a></code>. Column names ending with
<code>_date</code> are recognised as date records.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  my_date <span class="op">=</span> <span class="va">char_date</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/process_ecotox_dates.html">process_ecotox_dates</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 7 × 1</span></span></span>
<span><span class="co">#&gt;   my_date   </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 1987-05-19</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 2021-05-01</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> <span style="color: #BB0000;">NA</span>        </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 1985-01-01</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 1999-01-19</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 2004-10-01</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> 2015-01-01</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Pepijn de Vries.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
